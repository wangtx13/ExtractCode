org jhotdraw draw import awt * import awt geom * import awt event * import javax swing * import util * import org jhotdraw app action actions delegation selection tool selection tool { private collection< action> drawing actions private collection< action> selection actions private javax swing timer popup timer private j popup menu popup menu delegation selection tool { this new linked list< action> new linked list< action> } delegation selection tool collection< action> drawing actions collection< action> selection actions { this drawing actions = drawing actions this selection actions = selection actions } set drawing actions collection< action> drawing actions { this drawing actions = drawing actions } set figure actions collection< action> selection actions { this selection actions = selection actions } mouse pressed mouse event evt { if popup timer != { popup timer stop popup timer = } if evt is popup trigger { handle popup menu evt } else { super mouse pressed evt popup timer = new javax swing timer 1000 new action listener { action performed action event aevt { handle popup menu evt popup timer = } } popup timer set repeats popup timer start } } mouse released mouse event evt { if popup timer != { popup timer stop popup timer = } super mouse released evt if evt is popup trigger { handle popup menu evt } } mouse dragged mouse event evt { if popup timer != { popup timer stop popup timer = } if popup menu == || ! popup menu is visible { super mouse dragged evt } } mouse clicked mouse event evt { super mouse clicked evt if evt get click count == 2 { handle click evt } } handle popup menu mouse event evt { point p = new point evt get x evt get y figure figure = get view find figure p if figure != || drawing actions size > 0 { show popup menu figure p evt get component } else { popup menu = } } show popup menu figure figure point p component c { j popup menu menu = new j popup menu popup menu = menu j menu submenu = submenu name = linked list< action> popup actions = new linked list< action> if figure != { linked list< action> figure actions = new linked list< action> figure get actions view to drawing p if popup actions size != 0 figure actions size != 0 { popup actions add } popup actions add all figure actions if popup actions size != 0 selection actions size != 0 { popup actions add } popup actions add all selection actions } if popup actions size != 0 drawing actions size != 0 { popup actions add } popup actions add all drawing actions hash map< button group> button groups = new hash map< button group> for action a popup actions { if a != a get value actions SUBMENU_KEY != { if submenu name == || ! submenu name equals a get value actions SUBMENU_KEY { submenu name = a get value actions SUBMENU_KEY submenu = new j menu submenu name menu add submenu } } else { submenu name = submenu = } if a == { if submenu != submenu add separator else menu add separator } else { button button if a get value actions BUTTON_GROUP_KEY != { button group bg = button groups get a get value actions BUTTON_GROUP_KEY if bg == { bg = new button group button groups put a get value actions BUTTON_GROUP_KEY bg } button = new j radio button menu item a bg add button button set selected a get value actions SELECTED_KEY == t r u e } else if a get value actions SELECTED_KEY != { button = new j check box menu item a button set selected a get value actions SELECTED_KEY == t r u e } else { button = new j menu item a } if submenu != submenu add button else menu add button } } menu show c p x p y } handle click mouse event evt { drawing view v = get view point pos = new point evt get x evt get y handle handle = v find handle pos if handle != { handle track click pos evt get modifiers ex } else { point2 d p = view to drawing pos figure outer figure = get view find figure pos figure figure = outer figure if figure != { tool figure tool = figure get tool p if figure tool == { figure = get drawing find figure inside p if figure != { figure tool = figure get tool p } } if figure tool != { set tracker figure tool figure tool mouse pressed evt } else { if outer figure handle mouse click p evt get view { v clear selection v add to selection outer figure } else { v clear selection v add to selection outer figure v set handle detail level v get handle detail level + 1 } } } } } } 