org jhotdraw draw import org jhotdraw undo * import org jhotdraw util * import awt * import awt geom * import awt event * import util * import awt dnd * connection tool tool implements figure listener { private map< attribute key object> attributes private connector start connector private connector end connector private connector target connector private figure target private connection figure connection private split point private connection figure edited connection private figure created figure connection figure prototype is pressed connection tool connection figure prototype { this prototype = prototype } connection tool connection figure prototype map attributes { this prototype = prototype this attributes = attributes } connection tool prototype name { this prototype name } connection tool prototype name map< attribute key object> attributes { try { this prototype = connection figure for name prototype name new instance } catch e { internal = new internal unable to create connection figure from +prototype name init cause e throw } this attributes = attributes } connection figure get prototype { prototype } mouse moved mouse event evt { track connectors evt } mouse pressed mouse event evt { super mouse pressed evt is pressed = get view clear selection point2 d ap = view to drawing anchor if get target figure != { get target figure set connectors visible } set target figure find connection start ap get drawing if get target figure != { set start connector find connector ap target prototype if get start connector != can connect get target figure { point2 d p = get start connector get anchor set connection create figure get connection basic set bounds p p get connection add figure listener this set created figure get connection } } } mouse dragged awt event mouse event e { point2 d p = view to drawing new point e get x e get y if get connection != { track connectors e if get target connector != { p = get target connector get anchor } connection figure f = get connection fire area invalidated f get draw bounds f will change f basic set bounds f get start point p f changed fire area invalidated f get draw bounds } else if edited connection != { edited connection will change edited connection set point split point p edited connection changed } } can connect figure start { prototype can connect start } can connect figure start figure end { prototype can connect start end } mouse released mouse event e { is pressed = is working = figure c = point2 d p = view to drawing new point e get x e get y if get start connector != { c = find target p get drawing } if c != { set end connector find connector p c prototype if get end connector != { composite edit creation edit = new composite edit verbindung erstellen get drawing fire undoable edit happened creation edit connection figure f = get connection f will change f set start connector get start connector f set end connector get end connector f basic set bounds f get start point p f update connection f changed f remove figure listener this get drawing add f get drawing fire undoable edit happened creation edit } } else if get connection != { get drawing remove get connection } set connection set start connector set end connector set created figure fire tool done } activate drawing editor editor { super activate editor } deactivate drawing editor editor { super deactivate editor if get target figure != { get target figure set connectors visible } } connection figure create figure { connection figure f = connection figure prototype clone get editor apply default attributes to f if attributes != { for map entry< attribute key object> entry attributes entry set { f set attribute attribute key entry get key entry get value } } f } figure find source point2 d p drawing drawing { find connectable figure p drawing } figure find target point2 d p drawing drawing { figure target = find connectable figure p drawing figure start = get start connector get owner if target != get connection != can connect target can connect start target { target } } connection figure find connection point2 d p drawing drawing { for figure f drawing get figures front to back { if f != f instanceof connection figure { connection figure f } } } set connection connection figure new connection { connection = new connection } connection figure get connection { connection } track connectors mouse event e { point2 d p = view to drawing new point e get x e get y figure c = if get start connector == { c = find source p get drawing } else { c = find target p get drawing } if c != get target figure { if get target figure != { get target figure set connectors visible } set target figure c if get start connector != { if get target figure != can connect get start connector get owner get target figure { get target figure set connectors visible get connection } } else { if get target figure != can connect get target figure { get target figure set connectors visible get connection } } } connector cc = if c != { cc = find connector p c prototype } if cc != get target connector { set target connector cc } } draw graphics2 d g { if created figure != { graphics2 d gg = graphics2 d g create gg transform get view get drawing to view transform created figure draw gg gg dispose } } connector find connector point2 d p figure target connection figure f { target find connector p f } figure find connection start point2 d p drawing drawing { figure target = find connectable figure p drawing if target != target can connect { target } } figure find connectable figure point2 d p drawing drawing { drawing find figure except p created figure } set start connector connector new start connector { start connector = new start connector } connector get start connector { start connector } set end connector connector new end connector { end connector = new end connector } connector get end connector { end connector } private set target connector connector new target connector { target connector = new target connector } connector get target connector { target connector } private set target figure figure new target { target = new target } figure get target figure { target } figure get created figure { created figure } set created figure figure new created figure { created figure = new created figure } figure area invalidated figure event evt { fire area invalidated evt get invalidated area } figure added figure event e { } figure changed figure event e { } figure removed figure event e { } figure request remove figure event e { } figure attribute changed figure event e { } } 