org jhotdraw draw import org jhotdraw util * import awt * import awt event * import awt geom * import util * import javax swing undo * import io * import org jhotdraw geom * import org jhotdraw xml dom input import org jhotdraw xml dom output line connection figure line figure implements connection figure { private connector start connector private connector end connector private liner liner private connection handler connection handler = new connection handler this private connection handler implements figure listener { private line connection figure owner private connection handler line connection figure owner { this owner = owner } figure request remove figure event e { } figure removed figure event evt { owner fire figure request remove } figure changed figure event e { if e get source == owner get start figure || e get source == owner get end figure { owner will change owner update connection owner changed } } figure added figure event e { } figure attribute changed figure event e { } figure area invalidated figure event e { } } line connection figure { } basic transform affine transform tx { super basic transform tx update connection } collection< handle> create handles detail level { list< handle> handles = new list< handle> get node count switch detail level { case 0 if get liner == { for i = 1 n = get node count 1 i < n i++ { handles add new bezier node handle this i } } handles add new change connection start handle this handles add new change connection end handle this break } handles } can connect { } update connection { will change if get start connector != { point2 d start = get start connector find start this if start != { basic set start point start } } if get end connector != { point2 d end = get end connector find end this if end != { basic set end point end } } changed } validate { super validate lineout } can connect figure start figure end { start can connect end can connect } connects same connection figure other { other get start connector == get start connector other get end connector == get end connector } connector get end connector { end connector } figure get end figure { end connector == ? end connector get owner } connector get start connector { start connector } figure get start figure { start connector == ? start connector get owner } set end connector connector new end { connector old end = end connector if new end != old end { will change basic set end connector new end fire undoable edit happened new undoable edit { get presentation name { end verbindung setzen } undo cannot undo { super undo will change basic set end connector old end changed } redo cannot undo { super redo will change basic set end connector new end changed } } changed } } basic set end connector connector new end { if new end != end connector { if end connector != { get end figure remove figure listener connection handler if get start figure != { handle disconnect get start figure get end figure } } end connector = new end if end connector != { get end figure add figure listener connection handler if get start figure != get end figure != { handle connect get start figure get end figure update connection } } } } set start connector connector new start { connector old start = start connector if new start != old start { will change basic set start connector new start fire undoable edit happened new undoable edit { get presentation name { start verbindung setzen } undo cannot undo { super undo will change basic set start connector old start changed } redo cannot undo { super redo will change basic set start connector new start changed } } changed } } basic set start connector connector new start { if new start != start connector { if start connector != { get start figure remove figure listener connection handler if get end figure != { handle disconnect get start figure get end figure } } start connector = new start if start connector != { get start figure add figure listener connection handler if get start figure != get end figure != { handle connect get start figure get end figure update connection } } } } add notify drawing drawing { super add notify drawing } remove notify drawing drawing { super remove notify drawing } handle disconnect figure start figure end { } handle connect figure start figure end { } line connection figure clone { line connection figure that = line connection figure super clone that connection handler = new connection handler that if this liner != { that liner = liner this liner clone } if this start connector != { that start connector = connector this start connector clone that get start figure add figure listener that connection handler } if this end connector != { that end connector = connector this end connector clone that get end figure add figure listener that connection handler } if that start connector != that end connector != { that handle connect that get start figure that get end figure that update connection } that } remap map old to new { will change super remap old to new figure new start figure = figure new end figure = if get start figure != { new start figure = figure old to new get get start figure if new start figure == new start figure = get start figure } if get end figure != { new end figure = figure old to new get get end figure if new end figure == new end figure = get end figure } if new start figure != { set start connector new start figure find compatible connector get start connector } if new end figure != { set end connector new end figure find compatible connector get end connector } update connection changed } can connect figure start { start can connect } handle mouse click point2 d p mouse event evt drawing view view { if get liner == evt get click count == 2 { will change index = basic split segment p float 5f / view get scale factor if index != 1 { bezier path node new node = get node index fire undoable edit happened new undoable edit { redo cannot redo { super redo will change basic add node index new node changed } undo cannot undo { super undo will change basic remove node index changed } } changed } } } read points dom input in i o { super read points in in open element start connector set start connector connector in read in close element in open element end connector set end connector connector in read in close element } read dom input in i o { read points in read attributes in read liner in } read liner dom input in i o { if in get element count liner > 0 { in open element liner liner = liner in read in close element } } write dom output out i o { write points out write attributes out write liner out } write liner dom output out i o { if liner != { out open element liner out write liner out close element } } write points dom output out i o { super write points out out open element start connector out write get start connector out close element out open element end connector out write get end connector out close element } set liner liner new value { will change this liner = new value changed } basic set node index bezier path node p { if index != 0 index != get point count 1 { if get start connector != { point2 d start = get start connector find start this if start != { basic set start point start } } if get end connector != { point2 d end = get end connector find end this if end != { basic set end point end } } } super basic set node index p } lineout { if liner != { liner lineout this } } bezier path get bezier path { path } liner get liner { liner } set start point point2 d p { set point 0 p } set point index point2 d p { set point index 0 p } set end point point2 d p { set point get point count 1 p } reverse connection { if start connector != end connector != { handle disconnect start connector get owner end connector get owner connector tmp c = start connector start connector = end connector end connector = tmp c point2 d tmp p = get start point set start point get end point set end point tmp p handle connect start connector get owner end connector get owner update connection } } } 