org jhotdraw draw import awt * import awt geom * import util * import * import org jhotdraw draw AttributeKeys attribute keys * import org jhotdraw geom * import org jhotdraw xml DOMInput dom input import org jhotdraw xml DOMOutput dom output AttributedFigure attributed figure AbstractFigure figure { private HashMap<AttributeKey hash map< attribute key object> attributes = new HashMap<AttributeKey hash map< attribute key object> private HashSet<AttributeKey> hash set< attribute key> forbiddenAttributes forbidden attributes AttributedFigure attributed figure { } setAttribute set attribute AttributeKey attribute key key newValue new value { if forbiddenAttributes forbidden attributes == || ! forbiddenAttributes forbidden attributes contains key { oldValue old value = attributes get key if ! attributes containsKey contains key key || oldValue old value != newValue new value || oldValue old value != newValue new value != ! oldValue old value equals newValue new value { willChange will change basicSetAttribute basic set attribute key newValue new value fireAttributeChanged fire attribute changed key oldValue old value newValue new value fireUndoableEditHappened fire undoable edit happened new AttributeChangeEdit attribute change edit this key oldValue old value newValue new value changed } } } setAttributeEnabled set attribute enabled AttributeKey attribute key key { if forbiddenAttributes forbidden attributes == { forbiddenAttributes forbidden attributes = new HashSet<AttributeKey> hash set< attribute key> } if { forbiddenAttributes forbidden attributes remove key } else { forbiddenAttributes forbidden attributes add key } } isAttributeEnabled attribute enabled AttributeKey attribute key key { forbiddenAttributes forbidden attributes == || ! forbiddenAttributes forbidden attributes contains key } setAttributes set attributes HashMap<AttributeKey hash map< attribute key object> map { for map Entry<AttributeKey entry< attribute key object> entry map entrySet entry set { setAttribute set attribute entry getKey get key entry getValue get value } } Map<AttributeKey map< attribute key object> getAttributes get attributes { new HashMap<AttributeKey hash map< attribute key object> attributes } basicSetAttribute basic set attribute AttributeKey attribute key key newValue new value { if forbiddenAttributes forbidden attributes == || ! forbiddenAttributes forbidden attributes contains key { attributes put key newValue new value } } getAttribute get attribute AttributeKey attribute key key { hasAttribute has attribute key ? attributes get key key getDefaultValue get default value } drawFigure draw figure Graphics2D graphics2 { if AttributeKeys attribute keys FILL_COLOR get this != { setColor set color AttributeKeys attribute keys FILL_COLOR get this drawFill draw fill } if STROKE_COLOR get this != STROKE_WIDTH get this > 0d { setStroke set stroke AttributeKeys attribute keys getStroke get stroke this setColor set color STROKE_COLOR get this drawStroke draw stroke } if TEXT_COLOR get this != { if TEXT_SHADOW_COLOR get this != TEXT_SHADOW_OFFSET get this != { Dimension2DDouble dimension2 = TEXT_SHADOW_OFFSET get this translate width height setColor set color TEXT_SHADOW_COLOR get this drawText draw text translate width height } setColor set color TEXT_COLOR get this drawText draw text } if isConnectorsVisible connectors visible { drawConnectors draw connectors } } drawConnectors draw connectors Graphics2D graphics2 { } stroke getStroke get stroke { AttributeKeys attribute keys getStroke get stroke this } getStrokeMiterLimitFactor get stroke miter limit factor { number value = number getAttribute get attribute AttributeKeys attribute keys STROKE_MITER_LIMIT_FACTOR value != ? value doubleValue value 10f } Rectangle2D rectangle2 getFigureDrawBounds get figure draw bounds { width = AttributeKeys attribute keys getStrokeTotalWidth get stroke total width this / 2d if STROKE_JOIN get this == BasicStroke basic stroke JOIN_MITER { width *= STROKE_MITER_LIMIT_FACTOR get this } width++ Rectangle2D rectangle2 = getBounds get bounds geom grow width width } drawFill draw fill awt Graphics2D graphics2 drawStroke draw stroke awt Graphics2D graphics2 drawText draw text awt Graphics2D graphics2 { } AttributedFigure attributed figure clone { AttributedFigure attributed figure that = AttributedFigure attributed figure super clone that attributes = new HashMap<AttributeKey hash map< attribute key object> this attributes if this forbiddenAttributes forbidden attributes != { that forbiddenAttributes forbidden attributes = new HashSet<AttributeKey> hash set< attribute key> this forbiddenAttributes forbidden attributes } that } writeAttributes write attributes DOMOutput dom output out IOException { figure prototype = figure out getPrototype get prototype isElementOpen element open = for map Entry<AttributeKey entry< attribute key object> entry attributes entrySet entry set { AttributeKey attribute key key = entry getKey get key if forbiddenAttributes forbidden attributes == || ! forbiddenAttributes forbidden attributes contains key { prototypeValue prototype value = key get prototype attributeValue attribute value = key get this if prototypeValue prototype value != attributeValue attribute value || prototypeValue prototype value != attributeValue attribute value != ! prototypeValue prototype value equals attributeValue attribute value { if ! isElementOpen element open { out openElement open element isElementOpen element open = } out openElement open element key getKey get key out writeObject write entry getValue get value out closeElement close element } } } if isElementOpen element open { out closeElement close element } } readAttributes read attributes DOMInput dom input IOException { if getElementCount get element count > 0 { openElement open element for i=in getElementCount get element count 1 >= 0 { openElement open element = getTagName get tag value = readObject read AttributeKey attribute key key = getAttributeKey get attribute key if key != key isAssignable assignable value { if forbiddenAttributes forbidden attributes == || ! forbiddenAttributes forbidden attributes contains key { setAttribute set attribute key value } } closeElement close element } closeElement close element } } AttributeKey attribute key getAttributeKey get attribute key { AttributeKeys attribute keys supportedAttributeMap supported attribute map get } applyAttributesTo apply attributes to figure that { for map Entry<AttributeKey entry< attribute key object> entry attributes entrySet entry set { that setAttribute set attribute entry getKey get key entry getValue get value } } write DOMOutput dom output out IOException { Rectangle2D rectangle2 = getBounds get bounds out addAttribute add attribute out addAttribute add attribute out addAttribute add attribute width out addAttribute add attribute height writeAttributes write attributes out } read DOMInput dom input IOException { = getAttribute get attribute 0d = getAttribute get attribute 0d = getAttribute get attribute 0d = getAttribute get attribute 0d setBounds set bounds new Point2D point2 new Point2D point2 x+w y+h readAttributes read attributes } removeAttribute remove attribute AttributeKey attribute key key { if hasAttribute has attribute key { oldValue old value = getAttribute get attribute key attributes remove key fireAttributeChanged fire attribute changed key oldValue old value key getDefaultValue get default value } } hasAttribute has attribute AttributeKey attribute key key { attributes containsKey contains key key } } 