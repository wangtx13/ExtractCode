org jhotdraw app action import org jhotdraw io * import org jhotdraw gui * import org jhotdraw gui event * import org jhotdraw util * import awt * import awt event * import javax swing * import io * import org jhotdraw app application import org jhotdraw app project savebeforeaction save before action abstractprojectaction project action { private component oldfocusowner old focus owner savebeforeaction save before action application app { super app } actionperformed action performed actionevent action event evt { project p = getcurrentproject get current project if p isenabled is enabled { resourcebundleutil resource bundle util labels = resourcebundleutil resource bundle util getlafbundle get l a f bundle org jhotdraw app labels window wancestor w ancestor = swingutilities swing utilities getwindowancestor get window ancestor p getcomponent get component oldfocusowner old focus owner = wancestor w ancestor == ? wancestor w ancestor getfocusowner get focus owner p setenabled set enabled if p hasunsavedchanges has unsaved changes { joptionpane j option pane pane = new joptionpane j option pane <html> +uimanager + u i manager getstring get optionpane option pane css + labels getstring get savebeforemessage save before message joptionpane j option pane WARNING_MESSAGE options = { labels getstring get save labels getstring get cancel labels getstring get dontsave dont save } pane setoptions set options options pane setinitialvalue set initial value options 0 pane putclientproperty put client property quaqua optionpane option pane destructiveoption destructive option new integer 2 jsheet j sheet showsheet show sheet pane p getcomponent get component new sheetlistener sheet listener { optionselected option selected sheetevent sheet event evt { value = evt getvalue get value if value == || value equals labels getstring get cancel { p setenabled set enabled } else if value equals labels getstring get dontsave dont save { doit do it p p setenabled set enabled } else if value equals labels getstring get save { savechanges save changes p } } } } else { doit do it p p setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } } } } savechanges save changes project p { if p getfile get == { jfilechooser j chooser filechooser chooser = p getsavechooser get save chooser jsheet j sheet showsavesheet show save sheet filechooser chooser p getcomponent get component new sheetlistener sheet listener { optionselected option selected sheetevent sheet event evt { if evt getoption get option == jfilechooser j chooser APPROVE_OPTION { if evt getfilechooser get chooser getfilefilter get filter instanceof extensionfilefilter extension filter { = extensionfilefilter extension filter evt getfilechooser get chooser getfilefilter get filter makeacceptable make acceptable evt getfilechooser get chooser getselectedfile get selected } else { = evt getfilechooser get chooser getselectedfile get selected } savetofile save to p } else { p setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } } } } } else { savetofile save to p p getfile get } } savetofile save to project p { p execute new worker { construct { try { p write } catch ioexception i o e { e } } finished value { filesaved saved p value } } } filesaved saved project p value { if value == { p setfile set p markchangesassaved mark changes as saved doit do it p } else { resourcebundleutil resource bundle util labels = resourcebundleutil resource bundle util getlafbundle get l a f bundle org jhotdraw app labels jsheet j sheet showmessagesheet show message sheet p getcomponent get component <html> +uimanager + u i manager getstring get optionpane option pane css + labels getformatted get formatted couldntsave couldnt save value joptionpane j option pane ERROR_MESSAGE } p setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } } doit do it project p } 