net n3 nanoxml import io ioexception i o import io chararrayreader char reader import io reader import util enumeration import util properties import util vector stdxmlparser std xml parser implements ixmlparser i xml parser { private ixmlbuilder i xml builder builder private ixmlreader i xml reader reader private ixmlentityresolver i xml entity resolver entityresolver entity resolver private ixmlvalidator i xml validator validator stdxmlparser std xml parser { this builder = this validator = this reader = this entityresolver entity resolver = new xmlentityresolver xml entity resolver } finalize throwable { this builder = this reader = this entityresolver entity resolver = this validator = super finalize } setbuilder set builder ixmlbuilder i xml builder builder { this builder = builder } ixmlbuilder i xml builder getbuilder get builder { this builder } setvalidator set validator ixmlvalidator i xml validator validator { this validator = validator } ixmlvalidator i xml validator getvalidator get validator { this validator } setresolver set resolver ixmlentityresolver i xml entity resolver resolver { this entityresolver entity resolver = resolver } ixmlentityresolver i xml entity resolver getresolver get resolver { this entityresolver entity resolver } setreader set reader ixmlreader i xml reader reader { this reader = reader } ixmlreader i xml reader getreader get reader { this reader } parse xmlexception xml { try { this builder startbuilding start building this reader getsystemid get systemid this reader getlinenr get line nr this scandata scan data this builder getresult get result } catch xmlexception xml e { throw e } catch e { xmlexception xml = new xmlexception xml e initcause init cause e throw } } scandata scan data { while ! this reader ateof at e o f this builder getresult get result == { str = xmlutil xml util read this reader ' ' char ch = str charat char at 0 if ch == ' ' { xmlutil xml util processentity process entity str this reader this entityresolver entity resolver continue } switch ch { case '<' this scansometag scan some tag new properties break case ' ' case '\t' case '\r' case '\n' break default xmlutil xml util errorinvalidinput invalid input reader getsystemid get systemid reader getlinenr get line nr ` + ch + ' 0x + integer tohexstring to hex ch + ' ' } } } scansometag scan some tag allowcdata allow c d a t a defaultnamespace default namespace properties namespaces { str = xmlutil xml util read this reader ' ' char ch = str charat char at 0 if ch == ' ' { xmlutil xml util errorunexpectedentity unexpected entity reader getsystemid get systemid reader getlinenr get line nr str } switch ch { case '?' this processpi process p i break case '!' this processspecialtag process special tag allowcdata allow c d a t a break default this reader unread ch this processelement process element defaultnamespace default namespace namespaces } } processpi process p i { xmlutil xml util skipwhitespace skip whitespace this reader target = xmlutil xml util scanidentifier scan identifier this reader xmlutil xml util skipwhitespace skip whitespace this reader reader reader = new pireader p i reader this reader if ! target equalsignorecase equals ignore case xml { this builder newprocessinginstruction new processing instruction target reader } reader close } processspecialtag process special tag allowcdata allow c d a t a { str = xmlutil xml util read this reader ' ' char ch = str charat char at 0 if ch == ' ' { xmlutil xml util errorunexpectedentity unexpected entity reader getsystemid get systemid reader getlinenr get line nr str } switch ch { case ' ' if allowcdata allow c d a t a { this processcdata process c d a t a } else { xmlutil xml util errorunexpectedcdata unexpected c d a t a reader getsystemid get systemid reader getlinenr get line nr } case 'd' ' d' this processdoctype process doc type case ' ' xmlutil xml util skipcomment skip comment this reader } } processcdata process c d a t a { if ! xmlutil xml util checkliteral check literal this reader cdata c d a t a { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr <! cdata c d a t a } this validator pcdataadded p c data added this reader getsystemid get systemid this reader getlinenr get line nr reader reader = new cdatareader c d a t a reader this reader this builder addpcdata add p c data reader this reader getsystemid get systemid this reader getlinenr get line nr reader close } processdoctype process doc type { if ! xmlutil xml util checkliteral check literal this reader octype o c t y p e { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr <!doctype <! d o c t y p e } xmlutil xml util skipwhitespace skip whitespace this reader systemid = stringbuffer buffer publicid = new stringbuffer buffer rootelement root element = xmlutil xml util scanidentifier scan identifier this reader xmlutil xml util skipwhitespace skip whitespace this reader char ch = this reader read if ch == 'p' ' p' { systemid = xmlutil xml util scanpublicid scan publicid publicid reader xmlutil xml util skipwhitespace skip whitespace this reader ch = this reader read } else if ch == 's' ' s' { systemid = xmlutil xml util scansystemid scan systemid reader xmlutil xml util skipwhitespace skip whitespace this reader ch = this reader read } if ch == ' ' { this validator parsedtd parse d t d publicid tostring to this reader this entityresolver entity resolver xmlutil xml util skipwhitespace skip whitespace this reader ch = this reader read } if ch != '>' { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr `>' } if { if systemid != { reader reader = this reader openstream open stream publicid tostring to systemid this reader startnewstream start new stream reader this reader setsystemid set systemid systemid this reader setpublicid set publicid publicid tostring to this validator parsedtd parse d t d publicid tostring to this reader this entityresolver entity resolver } } } processelement process element defaultnamespace default namespace properties namespaces { fullname full name = xmlutil xml util scanidentifier scan identifier this reader name = fullname full name xmlutil xml util skipwhitespace skip whitespace this reader prefix = colonindex colon index = name indexof index of ' ' if colonindex colon index > 0 { prefix = name substring 0 colonindex colon index name = name substring colonindex colon index + 1 } vector attrnames attr names = new vector vector attrvalues attr values = new vector vector attrtypes attr types = new vector this validator elementstarted element started fullname full name this reader getsystemid get systemid this reader getlinenr get line nr char ch for { ch = this reader read if ch == '/' || ch == '>' { break } this reader unread ch this processattribute process attribute attrnames attr names attrvalues attr values attrtypes attr types xmlutil xml util skipwhitespace skip whitespace this reader } properties extraattributes extra attributes = new properties this validator elementattributesprocessed element attributes processed fullname full name extraattributes extra attributes this reader getsystemid get systemid this reader getlinenr get line nr enumeration enm = extraattributes extra attributes keys while enm hasmoreelements has more elements { key = enm nextelement next element value = extraattributes extra attributes getproperty get property key attrnames attr names addelement add element key attrvalues attr values addelement add element value attrtypes attr types addelement add element cdata c d a t a } for i = 0 i < attrnames attr names size i++ { key = attrnames attr names elementat element at i value = attrvalues attr values elementat element at i type = attrtypes attr types elementat element at i if key equals xmlns { defaultnamespace default namespace = value } else if key startswith starts with xmlns { namespaces put key substring 6 value } } if prefix == { this builder startelement start element name prefix defaultnamespace default namespace this reader getsystemid get systemid this reader getlinenr get line nr } else { this builder startelement start element name prefix namespaces getproperty get property prefix this reader getsystemid get systemid this reader getlinenr get line nr } for i = 0 i < attrnames attr names size i++ { key = attrnames attr names elementat element at i if key startswith starts with xmlns { continue } value = attrvalues attr values elementat element at i type = attrtypes attr types elementat element at i colonindex colon index = key indexof index of ' ' if colonindex colon index > 0 { attprefix att prefix = key substring 0 colonindex colon index key = key substring colonindex colon index + 1 this builder addattribute add attribute key attprefix att prefix namespaces getproperty get property attprefix att prefix value type } else { this builder addattribute add attribute key value type } } if prefix == { this builder elementattributesprocessed element attributes processed name prefix defaultnamespace default namespace } else { this builder elementattributesprocessed element attributes processed name prefix namespaces getproperty get property prefix } if ch == '/' { if this reader read != '>' { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr `>' } this validator elementended element ended name this reader getsystemid get systemid this reader getlinenr get line nr if prefix == { this builder endelement end element name prefix defaultnamespace default namespace } else { this builder endelement end element name prefix namespaces getproperty get property prefix } } stringbuffer buffer buffer = new stringbuffer buffer 16 for { buffer setlength set length 0 str for { xmlutil xml util skipwhitespace skip whitespace this reader buffer str = xmlutil xml util read this reader ' ' if str charat char at 0 == ' ' str charat char at 1 != '#' { xmlutil xml util processentity process entity str this reader this entityresolver entity resolver } else { break } } if str charat char at 0 == '<' { str = xmlutil xml util read this reader '\0' if str charat char at 0 == '/' { xmlutil xml util skipwhitespace skip whitespace this reader str = xmlutil xml util scanidentifier scan identifier this reader if ! str equals fullname full name { xmlutil xml util errorwrongclosingtag wrong closing tag reader getsystemid get systemid reader getlinenr get line nr name str } xmlutil xml util skipwhitespace skip whitespace this reader if this reader read != '>' { xmlutil xml util errorclosingtagnotempty closing tag not empty reader getsystemid get systemid reader getlinenr get line nr } this validator elementended element ended fullname full name this reader getsystemid get systemid this reader getlinenr get line nr if prefix == { this builder endelement end element name prefix defaultnamespace default namespace } else { this builder endelement end element name prefix namespaces getproperty get property prefix } break } else { this reader unread str charat char at 0 this scansometag scan some tag defaultnamespace default namespace properties namespaces clone } } else { if str charat char at 0 == ' ' { ch = xmlutil xml util processcharliteral process char literal str buffer append ch } else { reader unread str charat char at 0 } this validator pcdataadded p c data added this reader getsystemid get systemid this reader getlinenr get line nr reader r = new contentreader content reader this reader this entityresolver entity resolver buffer tostring to this builder addpcdata add p c data r this reader getsystemid get systemid this reader getlinenr get line nr r close } } } processattribute process attribute vector attrnames attr names vector attrvalues attr values vector attrtypes attr types { key = xmlutil xml util scanidentifier scan identifier this reader xmlutil xml util skipwhitespace skip whitespace this reader if ! xmlutil xml util read this reader ' ' equals = { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr `=' } xmlutil xml util skipwhitespace skip whitespace this reader value = xmlutil xml util scanstring scan this reader ' ' this entityresolver entity resolver attrnames attr names addelement add element key attrvalues attr values addelement add element value attrtypes attr types addelement add element cdata c d a t a this validator attributeadded attribute added key value this reader getsystemid get systemid this reader getlinenr get line nr } } 