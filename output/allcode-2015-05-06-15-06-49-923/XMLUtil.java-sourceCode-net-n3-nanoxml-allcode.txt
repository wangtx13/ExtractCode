net n3 nanoxml import io ioexception i o import io reader import io chararrayreader char reader xmlutil xml util { skipcomment skip comment ixmlreader i xml reader reader ioexception i o xmlparseexception xml parse { if reader read != ' ' { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr <! } dashesread dashes read = 0 for { char ch = reader read switch ch { case ' ' dashesread++ dashes read++ break case '>' if dashesread dashes read == 2 { } default dashesread dashes read = 0 } } } skiptag skip tag ixmlreader i xml reader reader ioexception i o xmlparseexception xml parse { level = 1 while level > 0 { char ch = reader read switch ch { case '<' ++level break case '>' level break } } } scanpublicid scan publicid stringbuffer buffer publicid ixmlreader i xml reader reader ioexception i o xmlparseexception xml parse { if ! xmlutil xml util checkliteral check literal reader ublic u b l i c { } xmlutil xml util skipwhitespace skip whitespace reader publicid append xmlutil xml util scanstring scan reader '\0' xmlutil xml util skipwhitespace skip whitespace reader xmlutil xml util scanstring scan reader '\0' } scansystemid scan systemid ixmlreader i xml reader reader ioexception i o xmlparseexception xml parse { if ! xmlutil xml util checkliteral check literal reader ystem y s t e m { } xmlutil xml util skipwhitespace skip whitespace reader xmlutil xml util scanstring scan reader '\0' } scanidentifier scan identifier ixmlreader i xml reader reader ioexception i o xmlparseexception xml parse { stringbuffer buffer result = new stringbuffer buffer for { char ch = reader read if ch == '_' || ch == ' ' || ch == ' ' || ch == ' ' || ch >= 'a' ch <= 'z' || ch >= 'a' ' a' ch <= 'z' ' z' || ch >= '0' ch <= '9' || ch > '\u007e' '\u007 e' { result append ch } else { reader unread ch break } } result tostring to } scanstring scan ixmlreader i xml reader reader char entitychar entity char ixmlentityresolver i xml entity resolver entityresolver entity resolver ioexception i o xmlparseexception xml parse { stringbuffer buffer result = new stringbuffer buffer startinglevel starting level = reader getstreamlevel get stream level char delim = reader read if delim != '\'' delim != ' ' { xmlutil xml util errorexpectedinput expected input reader getsystemid get systemid reader getlinenr get line nr delimited } for { str = xmlutil xml util read reader entitychar entity char char ch = str charat char at 0 if ch == entitychar entity char { if str charat char at 1 == '#' { result append xmlutil xml util processcharliteral process char literal str } else { xmlutil xml util processentity process entity str reader entityresolver entity resolver } } else if ch == ' ' { reader unread ch str = xmlutil xml util read reader ' ' if str charat char at 1 == '#' { result append xmlutil xml util processcharliteral process char literal str } else { result append str } } else if reader getstreamlevel get stream level == startinglevel starting level { if ch == delim { break } else if ch == 9 || ch == 10 || ch == 13 { result append ' ' } else { result append ch } } else { result append ch } } result tostring to } processentity process entity entity ixmlreader i xml reader reader ixmlentityresolver i xml entity resolver entityresolver entity resolver ioexception i o xmlparseexception xml parse { entity = entity substring 1 entity length 1 reader entityreader entity reader = entityresolver entity resolver getentity get entity reader entity if entityreader entity reader == { xmlutil xml util errorinvalidentity invalid entity reader getsystemid get systemid reader getlinenr get line nr entity } externalentity external entity = entityresolver entity resolver isexternalentity is external entity entity reader startnewstream start new stream entityreader entity reader !externalentity !external entity } char processcharliteral process char literal entity ioexception i o xmlparseexception xml parse { if entity charat char at 2 == 'x' { entity = entity substring 3 entity length 1 char integer parseint parse entity 16 } else { entity = entity substring 2 entity length 1 char integer parseint parse entity 10 } } skipwhitespace skip whitespace ixmlreader i xml reader reader stringbuffer buffer buffer ioexception i o { char ch if buffer == { do { ch = reader read } while ch == ' ' || ch == '\t' || ch == '\n' } else { for { ch = reader read if ch != ' ' ch != '\t' ch != '\n' { break } if ch == '\n' { buffer append '\n' } else { buffer append ' ' } } } reader unread ch } read ixmlreader i xml reader reader char entitychar entity char ioexception i o xmlparseexception xml parse { char ch = reader read stringbuffer buffer buf = new stringbuffer buffer buf append ch if ch == entitychar entity char { while ch != ' ' { ch = reader read buf append ch } } buf tostring to } char readchar read char ixmlreader i xml reader reader char entitychar entity char ioexception i o xmlparseexception xml parse { str = xmlutil xml util read reader entitychar entity char char ch = str charat char at 0 if ch == entitychar entity char { xmlutil xml util errorunexpectedentity unexpected entity reader getsystemid get systemid reader getlinenr get line nr str } ch } checkliteral check literal ixmlreader i xml reader reader literal ioexception i o xmlparseexception xml parse { for i = 0 i < literal length i++ { if reader read != literal charat char at i { } } } errorexpectedinput expected input systemid linenr line nr expectedstring expected xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr expected + expectedstring expected } errorinvalidentity invalid entity systemid linenr line nr entity xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr invalid entity ` + entity + ' } errorunexpectedentity unexpected entity systemid linenr line nr entity xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr no entity reference is expected here + entity + } errorunexpectedcdata unexpected c d a t a systemid linenr line nr xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr no cdata c d a t a section is expected here } errorinvalidinput invalid input systemid linenr line nr unexpectedstring unexpected xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr invalid input + unexpectedstring unexpected } errorwrongclosingtag wrong closing tag systemid linenr line nr expectedname expected name wrongname wrong name xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr closing tag does not match opening tag ` + wrongname wrong name + ' != ` + expectedname expected name + ' } errorclosingtagnotempty closing tag not empty systemid linenr line nr xmlparseexception xml parse { throw new xmlparseexception xml parse systemid linenr line nr closing tag must be empty } errormissingelement missing element systemid linenr line nr parentelementname parent element name missingelementname missing element name xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation MISSING_ELEMENT systemid linenr line nr missingelementname missing element name element + parentelementname parent element name + expects to have a + missingelementname missing element name } errorunexpectedelement unexpected element systemid linenr line nr parentelementname parent element name unexpectedelementname unexpected element name xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation UNEXPECTED_ELEMENT systemid linenr line nr unexpectedelementname unexpected element name unexpected + unexpectedelementname unexpected element name + in a + parentelementname parent element name } errormissingattribute missing attribute systemid linenr line nr elementname element name attributename attribute name xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation MISSING_ATTRIBUTE systemid linenr line nr elementname element name attributename attribute name element + elementname element name + expects an attribute named + attributename attribute name } errorunexpectedattribute unexpected attribute systemid linenr line nr elementname element name attributename attribute name xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation UNEXPECTED_ATTRIBUTE systemid linenr line nr elementname element name attributename attribute name element + elementname element name + did not expect an attribute + named + attributename attribute name } errorinvalidattributevalue invalid attribute value systemid linenr line nr elementname element name attributename attribute name attributevalue attribute value xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation ATTRIBUTE_WITH_INVALID_VALUE systemid linenr line nr elementname element name attributename attribute name attributevalue attribute value invalid value for attribute + attributename attribute name } errormissingpcdata missing p c data systemid linenr line nr parentelementname parent element name xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation MISSING_PCDATA systemid linenr line nr missing #pcdata # p c d a t a in element + parentelementname parent element name } errorunexpectedpcdata unexpected p c data systemid linenr line nr parentelementname parent element name xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation UNEXPECTED_PCDATA systemid linenr line nr unexpected #pcdata # p c d a t a in element + parentelementname parent element name } validationerror validation systemid linenr line nr message elementname element name attributename attribute name attributevalue attribute value xmlvalidationexception xml validation { throw new xmlvalidationexception xml validation xmlvalidationexception xml validation MISC_ERROR systemid linenr line nr elementname element name attributename attribute name attributevalue attribute value message } } 