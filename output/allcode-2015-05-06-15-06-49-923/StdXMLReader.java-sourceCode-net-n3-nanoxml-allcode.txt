net n3 nanoxml import io inputstream input stream import io inputstreamreader input stream reader import io ioexception i o import io import io fileinputstream input stream import io filenotfoundexception not found import io linenumberreader line number reader import io pushbackreader pushback reader import io pushbackinputstream pushback input stream import io reader import io stringreader reader import io unsupportedencodingexception unsupported encoding import net malformedurlexception malformed u r l import net url u r l import util stack stdxmlreader std xml reader implements ixmlreader i xml reader { private stackedreader stacked reader { pushbackreader pushback reader pbreader pb reader linenumberreader line number reader linereader line reader url u r l systemid publicid } private stack readers private stackedreader stacked reader currentreader current reader ixmlreader i xml reader stringreader reader str { new stdxmlreader std xml reader new stringreader reader str } ixmlreader i xml reader filereader reader filename filenotfoundexception not found ioexception i o { stdxmlreader std xml reader r = new stdxmlreader std xml reader new fileinputstream input stream filename r setsystemid set systemid filename for i = 0 i < r readers size i++ { stackedreader stacked reader sr = stackedreader stacked reader r readers elementat element at i sr systemid = r currentreader current reader systemid } r } stdxmlreader std xml reader publicid systemid malformedurlexception malformed u r l filenotfoundexception not found ioexception i o { url u r l systemidasurl systemidas u r l = try { systemidasurl systemidas u r l = new url u r l systemid } catch malformedurlexception malformed u r l e { systemid = + systemid try { systemidasurl systemidas u r l = new url u r l systemid } catch malformedurlexception malformed u r l e2 { throw e } } this currentreader current reader = new stackedreader stacked reader this readers = new stack reader reader = this openstream open stream publicid systemidasurl systemidas u r l tostring to this currentreader current reader linereader line reader = new linenumberreader line number reader reader this currentreader current reader pbreader pb reader = new pushbackreader pushback reader this currentreader current reader linereader line reader 2 } stdxmlreader std xml reader reader reader { this currentreader current reader = new stackedreader stacked reader this readers = new stack this currentreader current reader linereader line reader = new linenumberreader line number reader reader this currentreader current reader pbreader pb reader = new pushbackreader pushback reader this currentreader current reader linereader line reader 2 this currentreader current reader publicid = try { this currentreader current reader systemid = new url u r l } catch malformedurlexception malformed u r l e { } } finalize throwable { this currentreader current reader linereader line reader = this currentreader current reader pbreader pb reader = this currentreader current reader systemid = this currentreader current reader publicid = this currentreader current reader = this readers clear super finalize } getencoding get encoding str { if ! str startswith starts with <?xml { } index = 5 while index < str length { stringbuffer buffer key = new stringbuffer buffer while index < str length str charat char at index <= ' ' { index++ } while index < str length str charat char at index >= 'a' str charat char at index <= 'z' { key append str charat char at index index++ } while index < str length str charat char at index <= ' ' { index++ } if index >= str length || str charat char at index != '=' { break } while index < str length str charat char at index != '\'' str charat char at index != ' ' { index++ } if index >= str length { break } char delimiter = str charat char at index index++ index2 = str indexof index of delimiter index if index2 < 0 { break } if key tostring to equals encoding { str substring index index2 } index = index2 + 1 } } reader stream2reader inputstream input stream stream stringbuffer buffer charsread chars read ioexception i o { pushbackinputstream pushback input stream pbstream = new pushbackinputstream pushback input stream stream b = pbstream read switch b { case 0x00 case 0xfe 0x f e case 0xff 0x f f pbstream unread b new inputstreamreader input stream reader pbstream utf u t f 16 case 0xef 0x e f for i = 0 i < 2 i++ { pbstream read } new inputstreamreader input stream reader pbstream utf u t f 8 case 0x3c 0x3 c b = pbstream read charsread chars read append '<' while b > 0 b != 0x3e 0x3 e { charsread chars read append char b b = pbstream read } if b > 0 { charsread chars read append char b } encoding = this getencoding get encoding charsread chars read tostring to if encoding == { new inputstreamreader input stream reader pbstream utf u t f 8 } charsread chars read setlength set length 0 try { new inputstreamreader input stream reader pbstream encoding } catch unsupportedencodingexception unsupported encoding e { new inputstreamreader input stream reader pbstream utf u t f 8 } default charsread chars read append char b new inputstreamreader input stream reader pbstream utf u t f 8 } } stdxmlreader std xml reader inputstream input stream stream ioexception i o { pushbackinputstream pushback input stream pbstream = new pushbackinputstream pushback input stream stream stringbuffer buffer charsread chars read = new stringbuffer buffer reader reader = this stream2reader stream charsread chars read this currentreader current reader = new stackedreader stacked reader this readers = new stack this currentreader current reader linereader line reader = new linenumberreader line number reader reader this currentreader current reader pbreader pb reader = new pushbackreader pushback reader this currentreader current reader linereader line reader 2 this currentreader current reader publicid = try { this currentreader current reader systemid = new url u r l } catch malformedurlexception malformed u r l e { } this startnewstream start new stream new stringreader reader charsread chars read tostring to } char read ioexception i o { ch = this currentreader current reader pbreader pb reader read while ch < 0 { if this readers empty { throw new ioexception i o unexpected eof e o f } this currentreader current reader pbreader pb reader close this currentreader current reader = stackedreader stacked reader this readers pop ch = this currentreader current reader pbreader pb reader read } char ch } ateofofcurrentstream at e o f of current stream ioexception i o { ch = this currentreader current reader pbreader pb reader read if ch < 0 { } else { this currentreader current reader pbreader pb reader unread ch } } ateof at e o f ioexception i o { ch = this currentreader current reader pbreader pb reader read while ch < 0 { if this readers empty { } this currentreader current reader pbreader pb reader close this currentreader current reader = stackedreader stacked reader this readers pop ch = this currentreader current reader pbreader pb reader read } this currentreader current reader pbreader pb reader unread ch } unread char ch ioexception i o { this currentreader current reader pbreader pb reader unread ch } reader openstream open stream publicid systemid malformedurlexception malformed u r l filenotfoundexception not found ioexception i o { url u r l url = new url u r l this currentreader current reader systemid systemid if url getref get ref != { ref = url getref get ref if url getfile get length > 0 { url = new url u r l url getprotocol get protocol url gethost get host url getport get port url getfile get url = new url u r l jar + url + '!' + ref } else { url = stdxmlreader std xml reader getresource get resource ref } } this currentreader current reader publicid = publicid this currentreader current reader systemid = url stringbuffer buffer charsread chars read = new stringbuffer buffer reader reader = this stream2reader url openstream open stream charsread chars read if charsread chars read length == 0 { reader } charsreadstr chars read str = charsread chars read tostring to pushbackreader pushback reader pbreader = new pushbackreader pushback reader reader charsreadstr chars read str length for i = charsreadstr chars read str length 1 i >= 0 i { pbreader unread charsreadstr chars read str charat char at i } pbreader } startnewstream start new stream reader reader { this startnewstream start new stream reader } startnewstream start new stream reader reader isinternalentity is internal entity { stackedreader stacked reader oldreader old reader = this currentreader current reader this readers push this currentreader current reader this currentreader current reader = new stackedreader stacked reader if isinternalentity is internal entity { this currentreader current reader linereader line reader = this currentreader current reader pbreader pb reader = new pushbackreader pushback reader reader 2 } else { this currentreader current reader linereader line reader = new linenumberreader line number reader reader this currentreader current reader pbreader pb reader = new pushbackreader pushback reader this currentreader current reader linereader line reader 2 } this currentreader current reader systemid = oldreader old reader systemid this currentreader current reader publicid = oldreader old reader publicid } getstreamlevel get stream level { this readers size } getlinenr get line nr { if this currentreader current reader linereader line reader == { stackedreader stacked reader sr = stackedreader stacked reader this readers peek if sr linereader line reader == { 0 } else { sr linereader line reader getlinenumber get line number + 1 } } this currentreader current reader linereader line reader getlinenumber get line number + 1 } setsystemid set systemid systemid malformedurlexception malformed u r l { this currentreader current reader systemid = new url u r l this currentreader current reader systemid systemid } setpublicid set publicid publicid { this currentreader current reader publicid = publicid } getsystemid get systemid { this currentreader current reader systemid tostring to } getpublicid get publicid { this currentreader current reader publicid } } 