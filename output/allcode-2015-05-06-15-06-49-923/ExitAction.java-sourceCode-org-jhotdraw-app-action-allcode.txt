org jhotdraw app action import org jhotdraw gui * import org jhotdraw gui event * import org jhotdraw util * import awt * import awt event * import util * import javax swing * import io * import org jhotdraw app application import org jhotdraw app project exitaction exit action abstractapplicationaction application action { = exit private component oldfocusowner old focus owner private project unsavedproject unsaved project exitaction exit action application app { super app resourcebundleutil resource bundle util labels = resourcebundleutil resource bundle util getlafbundle get l a f bundle org jhotdraw app labels labels configureaction configure action this } actionperformed action performed actionevent action event evt { application app = getapplication get application if app isenabled is enabled { app setenabled set enabled unsavedprojectscount unsaved projects count = 0 project documenttobereviewed document to be reviewed = for project p app projects { if p hasunsavedchanges has unsaved changes { if p isenabled is enabled { documenttobereviewed document to be reviewed = p } unsavedprojectscount++ unsaved projects count++ } } if unsavedprojectscount unsaved projects count > 0 documenttobereviewed document to be reviewed == { app setenabled set enabled } switch unsavedprojectscount unsaved projects count { case 0 { doexit do exit break } case 1 { unsavedproject unsaved project = documenttobereviewed document to be reviewed oldfocusowner old focus owner = swingutilities swing utilities getwindowancestor get window ancestor unsavedproject unsaved project getcomponent get component getfocusowner get focus owner unsavedproject unsaved project setenabled set enabled joptionpane j option pane pane = new joptionpane j option pane <html> +uimanager + u i manager getstring get optionpane option pane css + <b>do <b> do you want to save changes to this document + before exiting?</b><p> + if you don't save your changes will be lost joptionpane j option pane WARNING_MESSAGE options = { save cancel don't save } pane setoptions set options options pane setinitialvalue set initial value options 0 pane putclientproperty put client property quaqua optionpane option pane destructiveoption destructive option new integer 2 jsheet j sheet showsheet show sheet pane unsavedproject unsaved project getcomponent get component new sheetlistener sheet listener { optionselected option selected sheetevent sheet event evt { value = evt getvalue get value if value == || value equals cancel { unsavedproject unsaved project setenabled set enabled app setenabled set enabled } else if value equals don't save { doexit do exit unsavedproject unsaved project setenabled set enabled } else if value equals save { savechanges save changes } } } break } default { joptionpane j option pane pane = new joptionpane j option pane <html> +uimanager + u i manager get optionpane option pane css + <b>you <b> you have +unsavedprojectscount+ +unsaved projects count+ documents with unsaved changes + do you want to + review these changes before quitting?</b><p> + if you don't review your documents + all your changes will be lost joptionpane j option pane QUESTION_MESSAGE options = { review changes cancel discard changes } pane setoptions set options options pane setinitialvalue set initial value options 0 pane putclientproperty put client property quaqua optionpane option pane destructiveoption destructive option new integer 2 jdialog j dialog dialog = pane createdialog create dialog app getcomponent get component dialog setvisible set visible value = pane getvalue get value if value == || value equals cancel { app setenabled set enabled } else if value equals discard changes { doexit do exit app setenabled set enabled } else if value equals review changes { unsavedproject unsaved project = documenttobereviewed document to be reviewed reviewchanges review changes } } } } } savechanges save changes { if unsavedproject unsaved project getfile get == { jfilechooser j chooser filechooser chooser = unsavedproject unsaved project getsavechooser get save chooser jsheet j sheet showsavesheet show save sheet filechooser chooser unsavedproject unsaved project getcomponent get component new sheetlistener sheet listener { optionselected option selected sheetevent sheet event evt { if evt getoption get option == jfilechooser j chooser APPROVE_OPTION { = evt getfilechooser get chooser getselectedfile get selected savetofile save to } else { unsavedproject unsaved project setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } getapplication get application setenabled set enabled } } } } else { savetofile save to unsavedproject unsaved project getfile get } } reviewchanges review changes { if unsavedproject unsaved project isenabled is enabled { oldfocusowner old focus owner = swingutilities swing utilities getwindowancestor get window ancestor unsavedproject unsaved project getcomponent get component getfocusowner get focus owner unsavedproject unsaved project setenabled set enabled joptionpane j option pane pane = new joptionpane j option pane <html> +uimanager + u i manager getstring get optionpane option pane css + <b>do <b> do you want to save changes to this document + before exiting?</b><p> + if you don't save your changes will be lost joptionpane j option pane WARNING_MESSAGE options = { save cancel don't save } pane setoptions set options options pane setinitialvalue set initial value options 0 pane putclientproperty put client property quaqua optionpane option pane destructiveoption destructive option new integer 2 jsheet j sheet showsheet show sheet pane unsavedproject unsaved project getcomponent get component new sheetlistener sheet listener { optionselected option selected sheetevent sheet event evt { value = evt getvalue get value if value == || value equals cancel { unsavedproject unsaved project setenabled set enabled getapplication get application setenabled set enabled } else if value equals don't save { getapplication get application dispose unsavedproject unsaved project reviewnext review next } else if value equals save { savechangesandreviewnext save changes and review next } } } } else { getapplication get application setenabled set enabled out review silently aborted } } savechangesandreviewnext save changes and review next { if unsavedproject unsaved project getfile get == { jfilechooser j chooser filechooser chooser = unsavedproject unsaved project getsavechooser get save chooser jsheet j sheet showsavesheet show save sheet filechooser chooser unsavedproject unsaved project getcomponent get component new sheetlistener sheet listener { optionselected option selected sheetevent sheet event evt { if evt getoption get option == jfilechooser j chooser APPROVE_OPTION { = evt getfilechooser get chooser getselectedfile get selected savetofileandreviewnext save to and review next } else { unsavedproject unsaved project setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } getapplication get application setenabled set enabled } } } } else { savetofileandreviewnext save to and review next unsavedproject unsaved project getfile get } } reviewnext review next { unsavedprojectscount unsaved projects count = 0 project documenttobereviewed document to be reviewed = for project p getapplication get application projects { if p hasunsavedchanges has unsaved changes { if p isenabled is enabled { documenttobereviewed document to be reviewed = p } unsavedprojectscount++ unsaved projects count++ } } if unsavedprojectscount unsaved projects count == 0 { doexit do exit } else if documenttobereviewed document to be reviewed != { unsavedproject unsaved project = documenttobereviewed document to be reviewed reviewchanges review changes } else { getapplication get application setenabled set enabled } } savetofile save to { unsavedproject unsaved project execute new worker { construct { try { unsavedproject unsaved project write } catch ioexception i o e { e } } finished value { filesaved saved unsavedproject unsaved project value } } } savetofileandreviewnext save to and review next { unsavedproject unsaved project execute new worker { construct { try { unsavedproject unsaved project write } catch ioexception i o e { e } } finished value { filesavedandreviewnext saved and review next unsavedproject unsaved project value } } } filesaved saved project unsavedproject unsaved project value { if value == { unsavedproject unsaved project setfile set doexit do exit } else { jsheet j sheet showmessagesheet show message sheet unsavedproject unsaved project getcomponent get component <html> +uimanager + u i manager getstring get optionpane option pane css + <b>couldn't <b> couldn't save to the \ +file+ \ <p> + reason +value joptionpane j option pane ERROR_MESSAGE } unsavedproject unsaved project setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } getapplication get application setenabled set enabled } filesavedandreviewnext saved and review next project unsavedproject unsaved project value { if value == { unsavedproject unsaved project setfile set getapplication get application dispose unsavedproject unsaved project reviewnext review next } else { jsheet j sheet showmessagesheet show message sheet unsavedproject unsaved project getcomponent get component <html> +uimanager + u i manager getstring get optionpane option pane css + <b>couldn't <b> couldn't save to the \ +file+ \ <p> + reason +value joptionpane j option pane ERROR_MESSAGE } unsavedproject unsaved project setenabled set enabled if oldfocusowner old focus owner != { oldfocusowner old focus owner requestfocus request focus } getapplication get application setenabled set enabled } doexit do exit { getapplication get application stop exit 0 } } 