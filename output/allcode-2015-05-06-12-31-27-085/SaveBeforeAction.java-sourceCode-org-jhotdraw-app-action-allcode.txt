org jhotdraw app action import org jhotdraw * import org jhotdraw gui * import org jhotdraw gui event * import org jhotdraw util * import awt * import awt event * import javax swing * import * import org jhotdraw app application import org jhotdraw app project SaveBeforeAction save before action AbstractProjectAction project action { private component oldFocusOwner old focus owner SaveBeforeAction save before action application app { super app } actionPerformed action performed ActionEvent action event evt { project = getCurrentProject get current project if isEnabled enabled { ResourceBundleUtil resource bundle util labels = ResourceBundleUtil resource bundle util getLAFBundle get bundle org jhotdraw app labels window wAncestor ancestor = SwingUtilities swing utilities getWindowAncestor get window ancestor getComponent get component oldFocusOwner old focus owner = wAncestor ancestor == ? wAncestor ancestor getFocusOwner get focus owner setEnabled set enabled if hasUnsavedChanges has unsaved changes { JOptionPane option pane pane = new JOptionPane option pane <html> +UIManager + manager getString get OptionPane option pane css + labels getString get saveBeforeMessage save before message JOptionPane option pane WARNING_MESSAGE options = { labels getString get save labels getString get cancel labels getString get dontSave dont save } pane setOptions set options options pane setInitialValue set initial value options 0 pane putClientProperty put client property quaqua OptionPane option pane destructiveOption destructive option new integer 2 JSheet sheet showSheet show sheet pane getComponent get component new SheetListener sheet listener { optionSelected option selected SheetEvent sheet event evt { value = evt getValue get value if value == || value equals labels getString get cancel { setEnabled set enabled } else if value equals labels getString get dontSave dont save { doIt it setEnabled set enabled } else if value equals labels getString get save { saveChanges save changes } } } } else { doIt it setEnabled set enabled if oldFocusOwner old focus owner != { oldFocusOwner old focus owner requestFocus request focus } } } } saveChanges save changes project { if getFile get == { JFileChooser chooser fileChooser chooser = getSaveChooser get save chooser JSheet sheet showSaveSheet show save sheet fileChooser chooser getComponent get component new SheetListener sheet listener { optionSelected option selected SheetEvent sheet event evt { if evt getOption get option == JFileChooser chooser APPROVE_OPTION { if evt getFileChooser get chooser getFileFilter get filter instanceof ExtensionFileFilter extension filter { = ExtensionFileFilter extension filter evt getFileChooser get chooser getFileFilter get filter makeAcceptable make acceptable evt getFileChooser get chooser getSelectedFile get selected } else { = evt getFileChooser get chooser getSelectedFile get selected } saveToFile save to } else { setEnabled set enabled if oldFocusOwner old focus owner != { oldFocusOwner old focus owner requestFocus request focus } } } } } else { saveToFile save to getFile get } } saveToFile save to project { execute new worker { construct { try { write } catch IOException { } } finished value { fileSaved saved value } } } fileSaved saved project value { if value == { setFile set markChangesAsSaved mark changes saved doIt it } else { ResourceBundleUtil resource bundle util labels = ResourceBundleUtil resource bundle util getLAFBundle get bundle org jhotdraw app labels JSheet sheet showMessageSheet show message sheet getComponent get component <html> +UIManager + manager getString get OptionPane option pane css + labels getFormatted get formatted couldntSave couldnt save value JOptionPane option pane ERROR_MESSAGE } setEnabled set enabled if oldFocusOwner old focus owner != { oldFocusOwner old focus owner requestFocus request focus } } doIt it project } 